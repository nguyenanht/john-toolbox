# Name of workflow
name: "CI pytest"

# Define trigger
on: push

# Cancel the workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # Job
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NOTEBOOK_PORT: 8885
      PYTHON_PATH: .cache/poetry/john-toolbox-DJpFP61h-py3.8/bin/python
      DOMAIN_NAME_LOCAL: johntoolbox.localhost
      DEVICE: cpu
      DOCKER_RUNTIME: runc
    # define task
    steps:
      # 1. get content
      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      # 2. run pytest
      - name: Run env
        run: |
          make env
      # 3. cache
      - name: Cache Packages
        uses: actions/cache@v3
        with:
          path: .cache
          key: ${{ hashFiles('**/poetry.lock') }}-${{ hashFiles('.github/workflows/*.yml') }}
      # 4. install package
      - name: Install package
        run: |
          make install
      - name: Reclaim cache directory
        run: sudo chown -R 1001:1001 .cache
      # 5. run linter
      - name: "Linter"
        run: |
          make lint
      - name: "pwd"
        run: |
          echo $(whoami)
      - name: "ls"
        run: |
          ls -la .cache
      # 6. run pytest
      - name: Run pytest
        run: |
          make ci-pytest
      # 7. run generate docs
      - name: Test generate docs
        run: |
          make docs
        

